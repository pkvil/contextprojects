\startenvironment nio-environment

\mainlanguage[sv]

%%
%% F O N T S
%%

\setupbodyfont[cochineal,11pt]
\definebodyfontenvironment[10pt][interlinespace=13.5pt]
\definesymbol[leaf][\fontchar{leaf}] % by name

%%
%% P A P E R   A N D   P A G E   S I Z E
%%

\definepapersize[mypage][width=6in, height=9in]
\setuppapersize[A5][A5]

%%
%% P A G E   L A Y O U T
%%

\setuplayout[
    location={middle,left,doublesided},
    grid=yes,
    marking=on,
   % TOP TO BOTTOM    
    topspace=\dimexpr(17.5mm-(2\baselineskip)),
    header=1\baselineskip,
    headerdistance=1\baselineskip,
    height=41\baselineskip,
    footerdistance=1\baselineskip,
    footer=2\lineheight,
   % INNER TO OUTER
%    backspace=\dimexpr(\paperwidth/8)\relax,% twosided
    backspace=19mm,% onesided
    leftmargin=0pt,
    leftmargindistance=0pt,
    width=111mm,
    rightmargin=64pt,
    rightmargindistance=16pt,
]

\setuppagenumbering[alternative=doublesided, location=,]

%%
%% S E C T I O N I N G
%%

\definepagebreak[emptypagebreak][yes,header,footer,right]

% FRONTMATTER

\startsectionblockenvironment[frontpart]
 % \setcounter[userpage][1]
 % \setupuserpagenumber [numberconversion=romannumerals]
\setupheadertexts[] % recto outer
                 [] % recto inner
                 [] % verso inner
                 [] % verso outer
\setupfootertexts[] % recto outer
                 [] % recto inner
                 [] % verso inner
                 [] % verso outer
\stopsectionblockenvironment

% BODYMATTER

\startsectionblockenvironment[bodypart]
    \setcounter[userpage][1]
\stopsectionblockenvironment

% CHAPTER

\setuphead[chapter][%
    page=emptypagebreak,
    number=no,
    before={\startlinecorrection\blank[2*line,force]},
    after={\stoplinecorrection\blank[3*line,force]},
    header=empty,
    alternative=middle,
    style={\tfc \feature[+][liningfigures]},
    textcommand={\kerncharacters[0.17]},
    deeptextcommand=\WORD,
]

%%
%% P A R A G R A P H
%%

\setupindenting[no,small] % indent paragraphs
\setupwhitespace[line] % whitespace between paragraphs

\setupspacing[packed] % French spacing

\setupitaliccorrection[text]

\setupalign[hanging,hz,tolerant] % microtypography, allow some stretching

%%
%% H E A D E R S   &   F O O T E R S
%%


\setupheadertexts[\hfill{\kerncharacters[0.17]\sc \getmarking[chapter]}\hfill] %recto outer
                 [] % recto inner
                 [] % verso inner
                 [\hfill{\kerncharacters[0.17]\sc Nio noveller i elfte timmen}\hfill] % verso outer

\setupfootertexts[\hfill \pagenumber \hfill] % recto outer
                 [] % recto inner
                 [] % verso inner
                 [\hfill \pagenumber \hfill] % verso outer

%%
%% M I S C
%%

\setupexternalfigures[directory=images]

%%
%% D R O P   C A P S
%%

% M

\define[1]\dropcapM{%
    \definefont[capfont][Serif at 49pt]
    \definefont[quotefont][Serif at 16pt]
    \noindent\kern -0.08em
%    \llap{\raise 2.4ex \hbox{\quotefont «}\kern 0em}%
    {\capfont M}
    \vskip-4\baselineskip
    \dimen1=3.85em
    \dimen2=3.85em
    \dimen3=3.85em
    \parshape 4
        \dimen1 \dimexpr\hsize-\dimen1
        \dimen2 \dimexpr\hsize-\dimen2       
        \dimen3 \dimexpr\hsize-\dimen3     
        0pc \hsize                                   
    \noindent{\kerncharacters[0.17]\sc #1}%            
}

\define[1]\dropcapD{%
    \definefont[capfont][Serif at 49pt]
    \definefont[quotefont][Serif at 16pt]
    \noindent\kern -0.16em
%    \llap{\raise 2.4ex \hbox{\quotefont «}\kern 0em}%
    {\capfont D}
    \vskip-4\baselineskip
    \dimen1=2.7em
    \dimen2=3.2em
    \dimen3=3.2em
    \parshape 4
        \dimen1 \dimexpr\hsize-\dimen1
        \dimen2 \dimexpr\hsize-\dimen2       
        \dimen3 \dimexpr\hsize-\dimen3     
        0pc \hsize                                   
    \noindent{\kerncharacters[0.16]\sc #1}%            
}

%%
%% V I S U A L   D E B U G G I N G
%%

%\showframe
%\showboxes
%\showgrid

%\enabletrackers[visualizers.justification]

\adaptlayout[7][lines=+1]
\adaptlayout[11][lines=+1]
\adaptlayout[14][lines=+1]


\stopenvironment
